<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Rosetta Chroma</title>
		<style>
			* {
				box-sizing: border-box;
			}
			body {
				font-family: system-ui, ui-sans-serif;
				margin: 0;
				padding: 4px 12px 12px 12px;
				color: #121212;
				font-size: 0.75rem;
				background-color: #fff;
				line-height: 1.5;
				width: 600px; /* Doubled width to make room for sidebar */
			}
			.container {
				display: flex;
				flex-direction: row; /* Changed from column to row */
				height: 100%;
			}

			h2 {
				margin: 0 0 4px 0;
				font-size: 0.75rem;
				font-weight: 600;
			}

			h3 {
				margin: 0;
				font-size: 0.75rem;
				font-weight: 600;
			}

			p {
				margin: 8px 0;
				font-size: 0.75px;
			}
			.color-display {
				display: flex;
				flex-direction: column;
				gap: 4px;
				margin-bottom: 8px;
			}
			.color-preview {
				width: 100%;
				height: 80px;
				border-radius: 2px;
				border: 1px solid #ddd;
				transition: all 0.3s ease;
				margin-bottom: 8px;
			}
			.color-info {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.color-hex,
			.contrast-value,
			.lch-value {
				font-family: monospace;
				font-size: 0.65rem;
				padding: 4px 0;
				width: 64px;
				text-align: right;
			}
			.lch-container {
				display: flex;
				flex-direction: column;
				gap: 8px;
			}
			.lch-row {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.lch-label {
				font-weight: 500;
				width: auto;
			}
			.lch-value {
				width: 64px;
				text-align: right;
			}

			.flavor-selector {
				display: flex;
				flex-direction: column;
				gap: 4px;
			}

			.flavor-selector select,
			.input-field[type="select"] {
				width: 100%;
				padding: 0 30px 0 8px; /* Increased right padding to make room for custom chevron */
				border-radius: 1px;
				border: 1px solid #ddd;
				background-color: #f7f7f5;
				margin: 0;
				font-size: 0.75rem;
				height: 28px;
				-webkit-appearance: none;
				-moz-appearance: none;
				appearance: none; /* Remove default appearance */
				background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%3E%3Cpath%20d%3D%22M7%209L3.5%205h7L7%209z%22%20fill%3D%22%23000000%22%2F%3E%3C%2Fsvg%3E");
				background-repeat: no-repeat;
				background-position: right 8px center;
			}

			/* Hide default arrow in IE */
			.flavor-selector select::-ms-expand,
			.input-field[type="select"]::-ms-expand {
				display: none;
			}

			.input-description {
				font-size: 0.65rem;
				color: #666;
				margin-top: 6px;
			}

			.info-title {
				font-weight: 600;
				font-size: 0.75rem;
				margin-bottom: 8px;
			}
			.info-content {
				font-size: 0.65rem;
				color: #666;
				margin-bottom: 16px;
			}
			.button {
				display: block;
				padding: 12px 16px;
				background-color: #000;
				color: white;
				border: none;
				border-radius: 2px;
				font-weight: 500;
				cursor: pointer;
				text-align: center;
				transition: background-color 0.2s;
				font-size: 0.75rem;
			}
			.button-tertiary {
				font-size: 0.65rem;
				padding: 0;
				background-color: #fff;
				height: 24px;
				color: #999;
				text-decoration: underline;
				border: none;
				cursor: pointer;
			}
			.button:hover {
				background-color: #212121;
			}
			.button:active {
				background-color: #303030;
			}
			.button:disabled {
				background-color: #cccccc;
				cursor: not-allowed;
			}
			.button-tertiary:hover {
				color: #212121;
			}
			.button-tertiary:active {
				color: #303030;
			}

			.button-footer {
				position: static;
				display: flex;
				flex-direction: column;
				justify-content: space-between;
				gap: 16px;
				width: 240px;
				height: 100%;
				background-color: #fff;
				border-left: 1px solid #eee;
				padding: 12px 0px 0px 8px;
			}

			#create-ramp-btn {
				width: 100%;
			}

			.button-group {
				display: flex;
				flex-direction: row;
				gap: 8px;
			}

			.button-group button {
				height: 24px;
			}

			.message {
				padding: 8px;
				border-radius: 2px;
				font-size: 0.75rem;
			}
			.message.error {
				background-color: #fff0f0;
				color: #e53e3e;
				border: 1px solid #feb2b2;
			}
			.message.success {
				background-color: #f0fff4;
				color: #38a169;
				border: 1px solid #9ae6b4;
			}
			.message.info {
				background-color: #ebf8ff;
				color: #3182ce;
				border: 1px solid #bee3f8;
			}
			.input-field {
				width: 100%;
				padding: 0 8px;
				border-radius: 1px;
				border: 1px solid #ddd;
				background-color: #f7f7f5;
				margin-top: 4px;
				font-size: 0.75rem;
				height: 28px;
			}
			.radio-group {
				display: flex;
				gap: 16px;
				margin-top: 8px;
			}

			.radio-option,
			.checkbox-option {
				display: flex;
				align-items: center;
				gap: 4px;
			}
			.checkbox-option label {
				width: 100%;
			}

			.section {
				border-bottom: 1px solid #eee;
				padding-bottom: 12px;
				/* margin-bottom: 12px; */
			}
			.ramp-section {
				display: none;
			}

			/* Tab styles */
			.tab-container {
				display: flex;
				flex-direction: column;
				height: 100%;
				overflow-y: auto;
				flex: 1; /* Take remaining space */
			}
			.tabs {
				display: flex;
				border-bottom: 1px solid #ddd;
				margin-bottom: 16px;
				color: #aaa;
			}
			.tab {
				width: 100%;
				padding: 8px 16px;
				cursor: pointer;
				font-weight: 500;
				border-bottom: 2px solid transparent;
				transition: all 0.3s ease;
				text-align: center;
			}
			.tab.active {
				border-bottom: 2px solid #000;
				color: #000;
			}

			.tab-content {
				display: none;
				flex-direction: column;
				gap: 12px;
				padding-bottom: 16px; /* Reduced padding since we don't need space for footer */
				padding-right: 8px; /* Add right padding to separate from sidebar */
				flex-grow: 1;
			}

			.tab-content.active {
				display: flex;
			}
			#variable-list p {
				font-size: 0.65rem;
				margin: 0 0 8px 0;
				color: #666;
			}
			.variable-list-item {
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.variable-list-item:last-child {
				border-bottom: none;
			}

			.advanced-mode-container {
				display: flex;
				flex-direction: column;
			}

			#advanced-mode-controls {
				display: flex;
				flex-direction: column;
				padding: 0px 0px 0px 12px;
				border-left: 1px solid #eee;
				display: none;
				margin-top: 12px;
				gap: 16px;
			}

			.contrast-targets-container {
				display: flex;
				flex-direction: column;
				gap: 8px;
			}

			.contrast-target-row {
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.contrast-target-row label {
				font-size: 0.65rem;
			}

			.contrast-input {
				margin: 0;
				width: 64px;
				padding: 0 4px;
				text-align: right;
			}

			.contrast-input::-webkit-outer-spin-button,
			.contrast-input::-webkit-inner-spin-button {
				-webkit-appearance: none;
				margin: 0;
			}

			/* Slider container styles */
			.slider-container {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			/* Slider styles */
			.slider {
				-webkit-appearance: none;
				appearance: none;
				height: 2px;
				border-radius: 2px;
				background: #ddd;
				outline: none;
				flex-grow: 1;
			}

			.slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 12px;
				height: 12px;
				border-radius: 2px;
				background: #000;
				cursor: pointer;
			}

			.slider::-moz-range-thumb {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: #000;
				cursor: pointer;
				border: none;
			}

			/* Curve preview graph */
			.curve-preview {
				position: relative;
			}

			#curve-canvas {
				width: 100%;
				height: 80px;
				background-color: #f7f7f5;
				border: 1px solid #ddd;
				border-radius: 2px;
			}

			.curve-labels {
				display: flex;
				justify-content: space-between;
				font-size: 0.6rem;
				color: #666;
				margin-top: 2px;
			}

			.axis-label {
				position: absolute;
				font-size: 0.6rem;
				color: #666;
			}

			.y-axis-label {
				transform: rotate(-90deg);
				transform-origin: top left;
				left: -4px;
				top: 40px;
			}

			.x-axis-label {
				bottom: -16px;
				left: 50%;
				transform: translateX(-50%);
			}

			/* Custom radio and checkbox styling */
			input[type="radio"],
			input[type="checkbox"] {
				-webkit-appearance: none;
				-moz-appearance: none;
				appearance: none;
				width: 16px;
				height: 16px;
				border: 1px solid #aaa;
				border-radius: 50%;
				outline: none;
				cursor: pointer;
				position: relative;
			}

			input[type="checkbox"] {
				border-radius: 2px;
			}

			input[type="radio"]:checked,
			input[type="checkbox"]:checked {
				background-color: #000;
				border-color: #000;
			}

			input[type="radio"]:checked:after {
				content: "";
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 6px;
				height: 6px;
				border-radius: 50%;
				background-color: white;
			}

			input[type="checkbox"]:checked:after {
				content: "";
				position: absolute;
				top: 0.5px;
				left: 4px;
				width: 4px;
				height: 8px;
				border: solid white;
				border-width: 0 2px 2px 0;
				transform: rotate(45deg);
			}

			input[type="radio"]:hover,
			input[type="checkbox"]:hover {
				border-color: #666;
			}
			#org-nested,
			#org-flat,
			#create-variables,
			#create-styles,
			#generation-mode-default,
			#generation-mode-advanced,
			#advanced-mode-toggle {
				margin: 0;
			}

			/* Stop sliders styling */
			.stops-container {
				display: flex;
				flex-direction: column;
				gap: 6px;
				margin-top: 8px;
			}

			.stop-row {
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 16px;
			}

			.stop-row label {
				width: 30px;
				font-size: 0.65rem;
			}

			.slider-container {
				display: flex;
				align-items: center;
				width: 100%;
				margin: 0;
				justify-content: flex-end;
			}

			.stop-value {
				width: 64px;
				height: 28px;
				padding: 0 8px;
				border-radius: 1px;
				border: 1px solid #ddd;
				background-color: #f7f7f5;
				font-size: 0.75rem;
				text-align: right;
			}

			/* Hide spinners in WebKit browsers */
			.stop-value::-webkit-outer-spin-button,
			.stop-value::-webkit-inner-spin-button {
				-webkit-appearance: none;
				margin: 0;
			}

			.luminance-controls,
			.chroma-controls,
			.hue-controls {
				display: flex;
				flex-direction: column;
				gap: 8px;
			}

			.hue-controls label {
				font-size: 0.75rem;
				font-weight: 500;
			}

			.controls-description {
				font-size: 0.65rem;
				color: #666;
				margin: 2px 0 0 0;
			}

			.preview-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 12px;
			}

			.preview-header h3 {
				margin: 0;
			}

			.preview-header-buttons {
				display: flex;
				gap: 8px;
				align-items: center;
			}

			.preview-header button {
				margin: 0;
				padding: 0;
				height: auto;
			}

			.preview-toggle-container {
				display: none; /* Hide the expand button container */
			}

			.preview-label {
				font-weight: 500;
				font-size: 0.75rem;
				color: #666;
			}

			.preview-expanded-header {
				display: flex;
				margin-bottom: 4px;
				font-size: 0.65rem;
				color: #999;
			}

			.preview-expanded-header-step {
				width: 40px;
			}

			.preview-expanded-header-color {
				flex-grow: 1;
				text-align: right;
				padding-right: 8px;
			}

			.preview-ramp-container {
				display: flex;
				height: 32px;
				width: 100%;
				border-radius: 2px;
				overflow: hidden;
			}

			.preview-swatch {
				flex: 1;
				transition: background-color 0.2s ease;
			}

			.preview-expanded {
				display: flex; /* Always show the expanded view */
				flex-direction: column;
				gap: 8px;
				margin-bottom: 8px;
				border-radius: 2px;
			}

			.preview-expanded-header {
				display: flex;
				margin-bottom: 4px;
				font-size: 0.65rem;
				color: #999;
			}

			.preview-expanded-header-step {
				width: 40px;
			}

			.preview-expanded-header-color {
				flex-grow: 1;
				text-align: right;
				padding-right: 8px;
			}

			.expanded-swatch-row {
				display: flex;
				align-items: center;
			}

			.expanded-swatch-label {
				font-weight: 500;
				font-size: 0.75rem;
				width: 40px;
				text-align: left;
				color: #666;
			}

			.expanded-swatch {
				flex-grow: 1;
				height: 36px;
				border-radius: 2px;
				transition: background-color 0.2s ease;
				position: relative;
				display: flex;
				align-items: center;
				justify-content: flex-end;
				padding-right: 8px;
				overflow: hidden;
			}

			.expanded-swatch-info {
				display: none; /* Hide by default, will be toggled by Reveal button */
				background-color: rgba(255, 255, 255, 0.7);
				padding: 2px 4px;
				border-radius: 2px;
				font-size: 0.65rem;
				font-family: monospace;
				color: #000; /* Default color for light backgrounds */
				min-width: 130px; /* Ensure enough width for the oklch format */
				text-align: right;
			}

			.expanded-swatch[data-step="100"] .expanded-swatch-info,
			.expanded-swatch[data-step="200"] .expanded-swatch-info {
				background-color: rgba(0, 0, 0, 0.6);
				color: #fff; /* Light text for dark backgrounds */
			}

			.show-info .expanded-swatch-info {
				display: block; /* Show when parent has show-info class */
			}

			.expanded-swatch:hover .expanded-swatch-info {
				background-color: rgba(
					255,
					255,
					255,
					0.9
				); /* Increased opacity on hover */
			}

			.expanded-swatch[data-step="100"]:hover .expanded-swatch-info,
			.expanded-swatch[data-step="200"]:hover .expanded-swatch-info {
				background-color: rgba(
					0,
					0,
					0,
					0.8
				); /* Darker background on hover for dark swatches */
			}

			.preview-ramp {
				display: flex;
				flex-direction: column;
				gap: 8px;
				overflow-y: auto;
				flex-grow: 1;
			}

			.preview-ramp h3 {
				margin: 0;
				font-size: 0.75rem;
				font-weight: 600;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="tab-container">
				<!-- Tab navigation -->
				<div class="tabs">
					<div class="tab active" data-tab="generation">Generation</div>
					<div class="tab" data-tab="application">Application</div>
				</div>

				<!-- Color Generation Tab -->
				<div id="generation-tab" class="tab-content active">
					<!-- Styles section for ramp frames -->
					<div id="styles-section" class="section ramp-section">
						<h2>Create Color Styles</h2>
						<div class="input-description" style="margin-bottom: 12px">
							Create Figma color styles and variables from the current ramp
							frame.
						</div>

						<div>
							<label for="style-name">Color Group Name</label>
							<input
								type="text"
								id="style-name"
								class="input-field"
								placeholder="e.g., Blue, Red, Brand"
							/>
							<div class="input-description" style="margin-top: 4px">
								This will be used to group variables in the "Colors" collection
							</div>
						</div>

						<div style="margin-top: 12px">
							<label>Organization Style</label>
							<div class="radio-group">
								<div class="radio-option">
									<input
										type="radio"
										id="org-nested"
										name="org-style"
										value="nested"
										checked
									/>
									<label for="org-nested">Nested (Blue/100)</label>
								</div>
								<div class="radio-option">
									<input
										type="radio"
										id="org-flat"
										name="org-style"
										value="flat"
									/>
									<label for="org-flat">Flat (Blue-100)</label>
								</div>
							</div>
						</div>

						<div style="margin-top: 12px">
							<label>Create As</label>
							<div class="radio-group" style="margin-top: 8px">
								<div class="radio-option">
									<input
										type="checkbox"
										id="create-variables"
										name="create-type"
										checked
									/>
									<label for="create-variables">Variables</label>
								</div>
								<div class="radio-option">
									<input
										type="checkbox"
										id="create-styles"
										name="create-type"
									/>
									<label for="create-styles">Color Styles</label>
								</div>
							</div>
						</div>

						<button
							id="create-styles-btn"
							class="button"
							style="margin-top: 12px"
						>
							Create Colors
						</button>
					</div>

					<div>
						<!-- <h2>Selected Color</h2> -->
						<div class="color-display">
							<div id="color-preview" class="color-preview"></div>
							<div class="color-info">
								<span>Hex</span>
								<span id="color-hex" class="color-hex">#000000</span>
							</div>
							<div class="color-info">
								<span>Contrast</span>
								<span id="contrast-value" class="contrast-value">21.0</span>
							</div>
							<div class="lch-row">
								<span class="lch-label">Luminance</span>
								<span id="lch-l" class="lch-value">0.00</span>
							</div>
							<div class="lch-row">
								<span class="lch-label">Chroma</span>
								<span id="lch-c" class="lch-value">0.00</span>
							</div>
							<div class="lch-row">
								<span class="lch-label">Hue</span>
								<span id="lch-h" class="lch-value">0</span>
							</div>
						</div>
					</div>

					<div class="advanced-mode-container">
						<div class="checkbox-option">
							<label for="advanced-mode-toggle">Advanced Mode</label>
							<input
								type="checkbox"
								id="advanced-mode-toggle"
								name="advanced-mode"
							/>
						</div>

						<!-- Advanced mode controls - initially hidden -->
						<div id="advanced-mode-controls">
							<div class="luminance-controls">
								<div>
									<h3>Luminance Curve</h3>
									<p class="controls-description">
										Set custom WCAG contrast targets for each step of the color
										each step of the color ramp
									</p>
								</div>
								<div class="contrast-targets-container">
									<div class="contrast-target-row">
										<label for="contrast-100">100</label>
										<input
											type="number"
											id="contrast-100"
											class="input-field contrast-input"
											value="12"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-200">200</label>
										<input
											type="number"
											id="contrast-200"
											class="input-field contrast-input"
											value="8"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-300">300</label>
										<input
											type="number"
											id="contrast-300"
											class="input-field contrast-input"
											value="5.5"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-400">400</label>
										<input
											type="number"
											id="contrast-400"
											class="input-field contrast-input"
											value="4.5"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-500">500</label>
										<input
											type="number"
											id="contrast-500"
											class="input-field contrast-input"
											value="3"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-600">600</label>
										<input
											type="number"
											id="contrast-600"
											class="input-field contrast-input"
											value="2.5"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-700">700</label>
										<input
											type="number"
											id="contrast-700"
											class="input-field contrast-input"
											value="1.4"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-800">800</label>
										<input
											type="number"
											id="contrast-800"
											class="input-field contrast-input"
											value="1.2"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-900">900</label>
										<input
											type="number"
											id="contrast-900"
											class="input-field contrast-input"
											value="1.1"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
									<div class="contrast-target-row">
										<label for="contrast-950">950</label>
										<input
											type="number"
											id="contrast-950"
											class="input-field contrast-input"
											value="1.05"
											min="1"
											max="21"
											step="0.1"
										/>
									</div>
								</div>
							</div>

							<div class="chroma-controls">
								<div>
									<h3>Chroma Curve</h3>
									<p class="controls-description">
										Customize the chroma (saturation) curve shape. Drag sliders
										to adjust chroma value for each stop.
									</p>
								</div>
								<div class="curve-controls">
									<div class="button-group">
										<button id="reset-stops" class="button-tertiary">
											Default
										</button>
										<button id="reset-stone" class="button-tertiary">
											Stone
										</button>
										<button id="reset-concrete" class="button-tertiary">
											Concrete
										</button>
									</div>
									<div class="stops-container">
										<div class="stop-row">
											<label for="stop-100">100</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-100"
													class="slider stop-slider"
													min="0"
													max="100"
													value="6"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-100-value"
													value="6"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-200">200</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-200"
													class="slider stop-slider"
													min="0"
													max="100"
													value="40"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-200-value"
													value="40"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-300">300</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-300"
													class="slider stop-slider"
													min="0"
													max="100"
													value="75"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-300-value"
													value="75"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-400">400</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-400"
													class="slider stop-slider"
													min="0"
													max="100"
													value="100"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-400-value"
													value="100"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-500">500</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-500"
													class="slider stop-slider"
													min="0"
													max="100"
													value="90"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-500-value"
													value="90"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-600">600</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-600"
													class="slider stop-slider"
													min="0"
													max="100"
													value="75"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-600-value"
													value="75"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-700">700</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-700"
													class="slider stop-slider"
													min="0"
													max="100"
													value="60"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-700-value"
													value="60"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-800">800</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-800"
													class="slider stop-slider"
													min="0"
													max="100"
													value="40"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-800-value"
													value="40"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-900">900</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-900"
													class="slider stop-slider"
													min="0"
													max="100"
													value="25"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-900-value"
													value="25"
													min="0"
													max="100"
												/>
											</div>
										</div>
										<div class="stop-row">
											<label for="stop-950">950</label>
											<div class="slider-container">
												<input
													type="range"
													id="stop-950"
													class="slider stop-slider"
													min="0"
													max="100"
													value="15"
												/>
												<input
													type="number"
													class="stop-value"
													id="stop-950-value"
													value="15"
													min="0"
													max="100"
												/>
											</div>
										</div>
									</div>
								</div>

								<!-- <div class="curve-preview">
									<div class="axis-label y-axis-label" style="display: none">
										Chroma
									</div>
									<p class="controls-description">Chroma curve</p>
									<canvas id="curve-canvas"></canvas>
									<div class="curve-labels">
										<span>100</span>
										<span>500</span>
										<span>950</span>
									</div>
									<div class="axis-label x-axis-label" style="display: none">
										Color Steps
									</div>
								</div> -->
							</div>

							<div class="hue-controls">
								<div>
									<h3>Hue Curve</h3>
									<p class="controls-description">
										Customize how hue shifts across the color ramp
									</p>
								</div>
								<div>
									<label for="hue-curve-value">Hue adjustment</label>
									<div
										class="slider-container"
										style="margin-top: 8px; display: flex; align-items: center"
									>
										<input
											type="range"
											id="hue-curve-value"
											class="slider"
											min="-250"
											max="250"
											value="0"
										/>
										<input
											type="number"
											class="stop-value"
											id="hue-curve-display"
											value="0"
											min="-250"
											max="250"
										/>
									</div>
									<div class="input-description" style="margin-top: 4px">
										Hue adjustment across steps 100 to 950
									</div>
								</div>
								<div>
									<label for="hue-curve-rate">Curve Rate</label>
									<select
										id="hue-curve-rate"
										class="input-field"
										style="margin-top: 8px"
									>
										<option value="early">Early (Front-loaded)</option>
										<option value="linear">Linear (Even)</option>
										<option value="late" selected>Late (Back-loaded)</option>
									</select>
									<div class="input-description" style="margin-top: 4px">
										Shape of the hue adjustment curve
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="flavor-selector" id="flavor-controls">
						<h2>Ramp Style</h2>
						<select id="flavor-select">
							<option value="bright">Bright</option>
							<!-- More options will be added dynamically -->
						</select>
						<div id="input-description" class="input-description">
							Vibrant colors with high saturation, ideal for modern UIs
						</div>
						<div class="info-section" id="info-section">
							<div class="info-title">What is this?</div>
							<div class="info-content">
								This generates 10 colors (100-950) with specific contrast ratios
								against white. Each style produces different chroma (saturation)
								curves, while maintaining WCAG contrast targets.
							</div>
						</div>
					</div>
				</div>

				<!-- Color Application Tab -->
				<div id="application-tab" class="tab-content">
					<div class="section">
						<h2>Variable Detection</h2>
						<div class="input-description" style="margin-bottom: 12px">
							Detect variables used in the selected layers
						</div>

						<button id="detect-variables-btn" class="button">
							Detect Variables
						</button>

						<div id="variable-results" style="margin-top: 16px; display: none">
							<h2>Variables Found</h2>
							<div
								id="variable-list"
								style="margin-top: 8px; overflow-y: auto; font-size: 0.65rem"
							></div>
						</div>
					</div>

					<div class="section">
						<h2>Replace Gray Variables</h2>
						<div class="input-description" style="margin-bottom: 12px">
							Replace Gray/100-950 variables with variables from another color
							group
						</div>

						<div style="margin-bottom: 12px">
							<label for="color-group-select">Replace with color group:</label>
							<select
								id="color-group-select"
								class="input-field"
								style="
									margin-top: 4px;
									-webkit-appearance: none;
									-moz-appearance: none;
									appearance: none;
									background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%3E%3Cpath%20d%3D%22M7%209L3.5%205h7L7%209z%22%20fill%3D%22%23000000%22%2F%3E%3C%2Fsvg%3E');
									background-repeat: no-repeat;
									background-position: right 8px center;
									padding-right: 30px;
								"
							>
								<option value="">-- Select a color group --</option>
							</select>
						</div>

						<button id="replace-gray-btn" class="button" disabled>
							Replace Gray Variables
						</button>

						<div
							id="replacement-info"
							class="message info"
							style="margin-top: 12px; display: none"
						>
							Select a frame or component to detect Gray variables, then choose
							a color group to replace them with. Gray/Base will be preserved.
						</div>
					</div>
				</div>
			</div>

			<!-- Sidebar (former footer) -->
			<div class="button-footer">
				<div class="preview-ramp">
					<div class="preview-header">
						<h3>Ramp Preview</h3>
						<div class="preview-header-buttons">
							<button id="format-toggle" class="button-tertiary">LCH</button>
							<button id="reveal-toggle" class="button-tertiary">Reveal</button>
						</div>
					</div>
					<div id="preview-expanded" class="preview-expanded">
						<div class="preview-expanded-header">
							<div class="preview-expanded-header-step">Step</div>
							<div class="preview-expanded-header-color">
								<span id="format-label">Hex • Contrast</span>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">100</div>
							<div class="expanded-swatch" data-step="100">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">200</div>
							<div class="expanded-swatch" data-step="200">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">300</div>
							<div class="expanded-swatch" data-step="300">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">400</div>
							<div class="expanded-swatch" data-step="400">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">500</div>
							<div class="expanded-swatch" data-step="500">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">600</div>
							<div class="expanded-swatch" data-step="600">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">700</div>
							<div class="expanded-swatch" data-step="700">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">800</div>
							<div class="expanded-swatch" data-step="800">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">900</div>
							<div class="expanded-swatch" data-step="900">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
						<div class="expanded-swatch-row">
							<div class="expanded-swatch-label">950</div>
							<div class="expanded-swatch" data-step="950">
								<div class="expanded-swatch-info"></div>
							</div>
						</div>
					</div>
				</div>
				<button id="create-ramp-btn" class="button" disabled>
					Create Color Ramp
				</button>
			</div>
		</div>

		<script>
			let currentColor = null;
			let availableFlavors = [];
			let selectedFlavor = "bright";
			let isRampFrame = false;
			let isAdvancedMode = false;
			let customContrastTargets = {
				100: 12,
				200: 8,
				300: 5.5,
				400: 4.5,
				500: 3,
				600: 2.5,
				700: 1.4,
				800: 1.2,
				900: 1.1,
				950: 1.05,
			};
			let chromaCurveSettings = {
				customStops: {
					100: 0.06,
					200: 0.4,
					300: 0.75,
					400: 1.0,
					500: 0.9,
					600: 0.75,
					700: 0.6,
					800: 0.4,
					900: 0.25,
					950: 0.15,
				},
			};
			let hueCurveSettings = {
				totalHueCurve: 0,
				curveRate: "late",
			};

			// Preset curves will be populated from the plugin
			let presetCurves = {};

			// Elements
			const colorPreview = document.getElementById("color-preview");
			const colorHex = document.getElementById("color-hex");
			const contrastValue = document.getElementById("contrast-value");
			const lchL = document.getElementById("lch-l");
			const lchC = document.getElementById("lch-c");
			const lchH = document.getElementById("lch-h");
			const flavorSelect = document.getElementById("flavor-select");
			const flavorControls = document.getElementById("flavor-controls");
			const flavorDescription = document.getElementById("input-description");
			const createRampBtn = document.getElementById("create-ramp-btn");
			const messageContainer = document.getElementById("message-container");
			const infoSection = document.getElementById("info-section");
			const stylesSection = document.getElementById("styles-section");
			const styleNameInput = document.getElementById("style-name");
			const createStylesBtn = document.getElementById("create-styles-btn");
			const createStylesCheckbox = document.getElementById("create-styles");
			const createVariablesCheckbox =
				document.getElementById("create-variables");
			const advancedModeToggle = document.getElementById(
				"advanced-mode-toggle"
			);
			const advancedModeControls = document.getElementById(
				"advanced-mode-controls"
			);
			const contrastInputs = document.querySelectorAll(".contrast-input");
			const resetStopsBtn = document.getElementById("reset-stops");
			const stopSliders = document.querySelectorAll(".stop-slider");
			const stopValues = document.querySelectorAll(".stop-value");
			const curveCanvas = document.getElementById("curve-canvas");
			const hueCurveSlider = document.getElementById("hue-curve-value");
			const hueCurveDisplay = document.getElementById("hue-curve-display");
			const hueCurveRate = document.getElementById("hue-curve-rate");
			const expandedSwatches = document.querySelectorAll(".expanded-swatch");
			const previewExpanded = document.getElementById("preview-expanded");
			const revealToggle = document.getElementById("reveal-toggle");
			const formatToggle = document.getElementById("format-toggle");
			const formatLabel = document.getElementById("format-label");
			// Always show expanded preview
			let isPreviewExpanded = true;
			let isInfoRevealed = false;
			let showLCH = false;

			// Canvas context for curve drawing
			const curveCtx = curveCanvas ? curveCanvas.getContext("2d") : null;
			const stopInputs = document.querySelectorAll(".stop-value");

			// Function to draw the chroma curve
			function drawChromaCurve() {
				if (!curveCanvas || !curveCtx) return;

				// Set canvas dimensions
				const canvasWidth = curveCanvas.offsetWidth;
				const canvasHeight = curveCanvas.offsetHeight;

				// Handle high DPI displays
				const dpr = window.devicePixelRatio || 1;
				curveCanvas.width = canvasWidth * dpr;
				curveCanvas.height = canvasHeight * dpr;
				curveCtx.scale(dpr, dpr);

				// Clear canvas
				curveCtx.clearRect(0, 0, canvasWidth, canvasHeight);

				// Draw background grid
				curveCtx.strokeStyle = "#ddd";
				curveCtx.lineWidth = 0.5;

				// Vertical grid lines
				const steps = [
					"100",
					"200",
					"300",
					"400",
					"500",
					"600",
					"700",
					"800",
					"900",
					"950",
				];
				for (let i = 0; i < steps.length; i++) {
					const x = (i / (steps.length - 1)) * canvasWidth;
					curveCtx.beginPath();
					curveCtx.moveTo(x, 0);
					curveCtx.lineTo(x, canvasHeight);
					curveCtx.stroke();
				}

				// Horizontal grid lines (4 divisions)
				for (let i = 0; i <= 4; i++) {
					const y = (i / 4) * canvasHeight;
					curveCtx.beginPath();
					curveCtx.moveTo(0, y);
					curveCtx.lineTo(canvasWidth, y);
					curveCtx.stroke();
				}

				// Draw the curve
				curveCtx.strokeStyle = "#444";
				curveCtx.lineWidth = 1;
				curveCtx.beginPath();

				steps.forEach((step, index) => {
					const x = (index / (steps.length - 1)) * canvasWidth;
					const y =
						canvasHeight - chromaCurveSettings.customStops[step] * canvasHeight;

					if (index === 0) {
						curveCtx.moveTo(x, y);
					} else {
						curveCtx.lineTo(x, y);
					}
				});

				curveCtx.stroke();
			}

			// Update the curve preview when settings change
			function updateCurvePreview() {
				drawChromaCurve();
			}

			// Initialize the curve preview
			function initCurvePreview() {
				if (curveCanvas) {
					// Set initial size
					curveCanvas.width = curveCanvas.offsetWidth;
					curveCanvas.height = curveCanvas.offsetHeight;

					// Draw initial curve
					drawChromaCurve();
				}
			}

			// Function to toggle showing hex/contrast information
			function toggleInfoReveal() {
				isInfoRevealed = !isInfoRevealed;
				revealToggle.textContent = isInfoRevealed ? "Hide" : "Reveal";

				// Toggle the class on the preview container that shows/hides info
				if (previewExpanded) {
					if (isInfoRevealed) {
						previewExpanded.classList.add("show-info");
					} else {
						previewExpanded.classList.remove("show-info");
					}
				}
			}

			// Function to toggle between Hex and LCH format
			function toggleFormat() {
				showLCH = !showLCH;
				formatToggle.textContent = showLCH ? "Hex" : "LCH";
				formatLabel.textContent = showLCH
					? "OKLCH • Contrast"
					: "Hex • Contrast";

				// Update the displayed values in all swatches
				updateSwatchInfoFormat();
			}

			// Function to update the format of info in all swatches
			function updateSwatchInfoFormat() {
				// We'll need to request updated information from the plugin
				// as we don't store the LCH values for all swatches in the UI
				if (currentColor) {
					updatePreviewRamp();
				}
			}

			// Add click handler for the format toggle button
			formatToggle.addEventListener("click", toggleFormat);

			// Add click handler for the reveal toggle button
			revealToggle.addEventListener("click", toggleInfoReveal);

			// Initialize based on current state
			setTimeout(() => {
				// Initialize curve preview if advanced mode is active on load
				if (advancedModeToggle.checked) {
					isAdvancedMode = true;
					advancedModeControls.style.display = "flex";
					flavorControls.style.display = "none";
					infoSection.style.display = "none";
					initCurvePreview();
				}

				// Initialize preview if there's a current color
				if (currentColor) {
					updatePreviewRamp();
				}
			}, 100);

			// Update curve when window is resized
			window.addEventListener("resize", () => {
				if (isAdvancedMode) {
					updateCurvePreview();
				}
			});

			// Stop slider event listeners
			stopSliders.forEach((slider) => {
				slider.addEventListener("input", () => {
					const step = slider.id.split("-")[1];
					const value = parseInt(slider.value);
					const valueElement = document.getElementById(`${slider.id}-value`);
					valueElement.value = value;
					chromaCurveSettings.customStops[step] = value / 100;
					updateCurvePreview();
					updatePreviewRamp();
				});
			});

			// Stop input event listeners for number inputs
			stopInputs.forEach((input) => {
				input.addEventListener("input", () => {
					const id = input.id.split("-value")[0]; // Convert "stop-100-value" to "stop-100"
					const step = id.split("-")[1]; // Extract "100"
					const slider = document.getElementById(id);
					let value = parseInt(input.value);

					// Clamp value between min and max
					if (value < 0) value = 0;
					if (value > 100) value = 100;

					// Update slider position
					slider.value = value;

					// Update curve settings
					chromaCurveSettings.customStops[step] = value / 100;

					// Update preview
					updateCurvePreview();
					updatePreviewRamp();
				});
			});

			// Reset stops button event listener
			resetStopsBtn.addEventListener("click", () => {
				applyPresetCurve("default");
				updatePreviewRamp();
			});

			// Stone curve reset button
			document.getElementById("reset-stone").addEventListener("click", () => {
				applyPresetCurve("stone");
				updatePreviewRamp();
			});

			// Concrete curve reset button
			document
				.getElementById("reset-concrete")
				.addEventListener("click", () => {
					applyPresetCurve("concrete");
					updatePreviewRamp();
				});

			// Hue curve value slider listener
			hueCurveSlider.addEventListener("input", () => {
				const value = parseInt(hueCurveSlider.value);
				hueCurveDisplay.value = value;
				hueCurveSettings.totalHueCurve = value;
				updatePreviewRamp();
			});

			// Hue curve input listener
			hueCurveDisplay.addEventListener("input", () => {
				let value = parseInt(hueCurveDisplay.value);

				// Clamp value between min and max
				if (value < -250) value = -250;
				if (value > 250) value = 250;

				// Update slider position
				hueCurveSlider.value = value;

				// Update settings
				hueCurveSettings.totalHueCurve = value;
				updatePreviewRamp();
			});

			// Hue curve rate dropdown listener
			hueCurveRate.addEventListener("change", () => {
				hueCurveSettings.curveRate = hueCurveRate.value;
				updatePreviewRamp();
			});

			// Function to apply a preset curve
			function applyPresetCurve(presetName) {
				const preset = presetCurves[presetName];
				if (!preset) return;

				// Update the chromaCurveSettings
				chromaCurveSettings.customStops = { ...preset };

				// Update all sliders and their values
				stopSliders.forEach((slider) => {
					const step = slider.id.split("-")[1];
					const value = Math.round(preset[step] * 100);
					slider.value = value;
					const valueElement = document.getElementById(`${slider.id}-value`);
					if (valueElement) {
						valueElement.value = value;
					}
				});

				// Update the curve preview
				updateCurvePreview();
			}

			// Tab elements
			const tabs = document.querySelectorAll(".tab");
			const tabContents = document.querySelectorAll(".tab-content");

			// Variable detection button
			const detectVariablesBtn = document.getElementById(
				"detect-variables-btn"
			);
			const variableResults = document.getElementById("variable-results");
			const variableList = document.getElementById("variable-list");

			// Variable replacement elements
			const colorGroupSelect = document.getElementById("color-group-select");
			const replaceGrayBtn = document.getElementById("replace-gray-btn");
			const replacementInfo = document.getElementById("replacement-info");

			// Tab switching logic
			tabs.forEach((tab) => {
				tab.addEventListener("click", () => {
					// Remove active class from all tabs and content
					tabs.forEach((t) => t.classList.remove("active"));
					tabContents.forEach((c) => c.classList.remove("active"));

					// Add active class to clicked tab and corresponding content
					tab.classList.add("active");
					const tabName = tab.getAttribute("data-tab");
					document.getElementById(`${tabName}-tab`).classList.add("active");
				});
			});

			// Generation mode toggle
			advancedModeToggle.addEventListener("change", () => {
				isAdvancedMode = advancedModeToggle.checked;
				advancedModeControls.style.display = isAdvancedMode ? "flex" : "none";
				flavorControls.style.display = isAdvancedMode ? "none" : "block";
				infoSection.style.display = isAdvancedMode ? "none" : "block";

				if (isAdvancedMode) {
					// Initialize the curve preview when advanced mode is enabled
					setTimeout(initCurvePreview, 10); // Small delay to ensure DOM is updated
				}

				// Update the preview ramp with the new settings
				updatePreviewRamp();
			});

			// Contrast input handlers
			contrastInputs.forEach((input) => {
				input.addEventListener("change", () => {
					const step = input.id.split("-")[1]; // Extract step number (100, 200, etc.)
					const value = parseFloat(input.value);

					// Validate input value (between 1 and 21)
					if (value < 1) input.value = "1";
					if (value > 21) input.value = "21";

					// Update custom contrast targets
					customContrastTargets[step] = parseFloat(input.value);

					// Update the preview
					updatePreviewRamp();
				});
			});

			// Update UI with selected color
			function updateSelectedColor(color, contrast, lch) {
				currentColor = color;
				colorPreview.style.backgroundColor = color;
				colorHex.textContent = color;
				contrastValue.textContent = contrast;

				// Update LCH values if provided
				if (lch) {
					lchL.textContent = lch.l;
					lchC.textContent = lch.c;
					lchH.textContent = lch.h;
				}

				createRampBtn.disabled = false;

				// Update the preview ramp
				updatePreviewRamp();
			}

			// Toggle the ramp frame UI
			function toggleRampFrameUI(isRamp) {
				isRampFrame = isRamp;
				if (stylesSection) {
					stylesSection.style.display = isRamp ? "block" : "none";
				}
			}

			// Show message
			function showMessage(message, type = "info") {
				if (!messageContainer) return;

				messageContainer.textContent = message;
				messageContainer.className = `message ${type}`;
				messageContainer.style.display = "block";

				// Auto-hide success and info messages after 3 seconds
				if (type === "success" || type === "info") {
					setTimeout(() => {
						if (messageContainer) {
							messageContainer.style.display = "none";
						}
					}, 3000);
				}
			}

			// Handle messages from the plugin
			window.onmessage = (event) => {
				const msg = event.data.pluginMessage;

				if (msg.type === "selected-color") {
					updateSelectedColor(msg.color, msg.contrastRatio, msg.lch);
					if (msg.flavors) {
						populateFlavors(msg.flavors);
					}
					toggleRampFrameUI(msg.isRampFrame);
					if (messageContainer) {
						messageContainer.style.display = "none";
					}

					// Update the preview ramp when color is selected
					updatePreviewRamp();
				} else if (msg.type === "preset-curves") {
					// Store the preset curves received from the plugin
					presetCurves = msg.curves;

					// Initialize the default curve settings
					if (presetCurves.default) {
						chromaCurveSettings.customStops = { ...presetCurves.default };
						// Update sliders to match the default curve
						applyPresetCurve("default");
					}
				} else if (msg.type === "no-selection" || msg.type === "no-fill") {
					currentColor = null;
					colorPreview.style.backgroundColor = "#EEEEEE";
					colorHex.textContent = "—";
					contrastValue.textContent = "—";
					lchL.textContent = "—";
					lchC.textContent = "—";
					lchH.textContent = "—";
					createRampBtn.disabled = true;
					toggleRampFrameUI(msg.isRampFrame || false);
					showMessage(msg.message, "info");
				} else if (msg.type === "ramp-created") {
					showMessage(msg.message, "success");
				} else if (msg.type === "styles-created") {
					showMessage(msg.message, "success");
				} else if (msg.type === "error") {
					showMessage(msg.message, "error");
				} else if (msg.type === "variables-detected") {
					// Format and display the detected variables
					variableResults.style.display = "block";
					variableList.innerHTML = ``; // Clear list, but we'll add the summary at the end

					// Switch to application tab
					tabs.forEach((t) => t.classList.remove("active"));
					tabContents.forEach((c) => c.classList.remove("active"));
					document
						.querySelector('[data-tab="application"]')
						.classList.add("active");
					document.getElementById("application-tab").classList.add("active");

					// Group variables by name for cleaner display
					const groupedByName = {};

					msg.variables.forEach((variable) => {
						if (!groupedByName[variable.variableName]) {
							groupedByName[variable.variableName] = [];
						}
						groupedByName[variable.variableName].push(variable);
					});

					// Create a list of variable names and counts
					for (const [name, instances] of Object.entries(groupedByName)) {
						const item = document.createElement("div");
						item.classList.add("variable-list-item");

						// Variable info on the left
						const varInfo = document.createElement("div");
						varInfo.innerHTML = `
							<strong>${name}</strong> <span style="color: #666">${instances.length} instances</span>
						`;

						// Select button on the right
						const selectBtn = document.createElement("button");
						selectBtn.textContent = "Select All";
						selectBtn.className = "button-tertiary";
						selectBtn.style.fontSize = "0.65rem";

						// Store the first instance's variable ID (all instances should reference the same variable)
						const variableId = instances[0].variableId;

						// Add click handler
						selectBtn.addEventListener("click", () => {
							parent.postMessage(
								{
									pluginMessage: {
										type: "select-by-variable",
										variableId: variableId,
									},
								},
								"*"
							);
						});

						// Add elements to container
						item.appendChild(varInfo);
						item.appendChild(selectBtn);
						variableList.appendChild(item);
					}

					// Add summary message at the bottom instead of the top
					const summaryMsg = document.createElement("p");
					summaryMsg.textContent = `${msg.count} variable instances`;
					summaryMsg.style.marginTop = "12px";
					variableList.appendChild(summaryMsg);
				} else if (msg.type === "nodes-selected") {
					// Show a success message when nodes are selected
					showMessage(msg.message, "success");
				} else if (msg.type === "no-variables") {
					// Show a message when no variables are found
					variableResults.style.display = "block";
					variableList.innerHTML = `<p>${msg.message}</p>`;
				} else if (msg.type === "color-groups") {
					// Populate the color group dropdown
					if (msg.groups && msg.groups.length > 0) {
						msg.groups.forEach((group) => {
							const option = document.createElement("option");
							option.value = group;
							option.textContent = group;
							colorGroupSelect.appendChild(option);
						});

						// Show the replacement info
						replacementInfo.style.display = "block";
						replacementInfo.textContent = `Found ${msg.groups.length} color groups that can replace Gray variables.`;
					} else {
						replacementInfo.style.display = "block";
						replacementInfo.textContent =
							"No color groups found. Create color variables first.";
					}
				} else if (msg.type === "variables-replaced") {
					// Show success message for variable replacement
					showMessage(msg.message, "success");

					// Update the replacement info with the result
					replacementInfo.style.display = "block";
					replacementInfo.textContent = msg.message;
				}
			};

			// Event listeners
			flavorSelect.addEventListener("change", () => {
				selectedFlavor = flavorSelect.value;
				updateFlavorDescription();
				updatePreviewRamp();
			});

			// Button event listeners
			createRampBtn.addEventListener("click", () => {
				if (currentColor) {
					parent.postMessage(
						{
							pluginMessage: {
								type: "create-ramp",
								color: currentColor,
								flavor: selectedFlavor,
								isAdvancedMode: isAdvancedMode,
								customContrastTargets: isAdvancedMode
									? customContrastTargets
									: null,
								chromaCurveSettings: isAdvancedMode
									? {
											customStops: chromaCurveSettings.customStops,
											hueCurveSettings: hueCurveSettings,
									  }
									: null,
							},
						},
						"*"
					);
				}
			});

			createStylesBtn.addEventListener("click", () => {
				const colorName = styleNameInput.value.trim();
				if (!colorName) {
					showMessage("Please enter a style collection name", "error");
					return;
				}

				const organizationStyle = document.querySelector(
					'input[name="org-style"]:checked'
				).value;
				const createStyles = createStylesCheckbox.checked;
				const createVariables = createVariablesCheckbox.checked;

				if (!createStyles && !createVariables) {
					showMessage(
						"Please select at least one token type to create",
						"error"
					);
					return;
				}

				parent.postMessage(
					{
						pluginMessage: {
							type: "create-styles",
							colorName: colorName,
							organizationStyle: organizationStyle,
							createStyles: createStyles,
							createVariables: createVariables,
						},
					},
					"*"
				);
			});

			// Variable detection button
			detectVariablesBtn.addEventListener("click", () => {
				// Hide any previous results
				variableResults.style.display = "none";
				variableList.innerHTML = "";

				// Send message to plugin code
				parent.postMessage(
					{
						pluginMessage: {
							type: "detect-variables",
						},
					},
					"*"
				);

				// After detecting variables, also load color groups
				loadColorGroups();
			});

			// Load color groups when variables are detected
			function loadColorGroups() {
				// Clear existing options (except the first placeholder)
				while (colorGroupSelect.options.length > 1) {
					colorGroupSelect.remove(1);
				}

				// Request color groups from the plugin
				parent.postMessage(
					{
						pluginMessage: {
							type: "get-color-groups",
						},
					},
					"*"
				);
			}

			// Enable/disable the replace button based on selection
			colorGroupSelect.addEventListener("change", () => {
				replaceGrayBtn.disabled = !colorGroupSelect.value;
			});

			// Replace Gray variables with the selected color group
			replaceGrayBtn.addEventListener("click", () => {
				const selectedGroup = colorGroupSelect.value;
				if (!selectedGroup) {
					showMessage("Please select a color group", "error");
					return;
				}

				parent.postMessage(
					{
						pluginMessage: {
							type: "replace-gray-variables",
							newColorGroup: selectedGroup,
						},
					},
					"*"
				);
			});

			// Populate flavor dropdown with available flavors
			function populateFlavors(flavors) {
				availableFlavors = flavors;
				flavorSelect.innerHTML = "";

				flavors.forEach((flavor) => {
					const option = document.createElement("option");
					option.value = flavor.id;
					option.textContent = flavor.name;
					flavorSelect.appendChild(option);
				});

				// Set initial selection
				flavorSelect.value = "bright";
				updateFlavorDescription();
			}

			// Update the flavor description when selection changes
			function updateFlavorDescription() {
				const selectedId = flavorSelect.value;
				const selectedFlavor = availableFlavors.find(
					(f) => f.id === selectedId
				);
				if (selectedFlavor) {
					flavorDescription.textContent = selectedFlavor.description;
				}
			}

			// Request preset curves when the UI loads
			window.addEventListener("load", () => {
				parent.postMessage(
					{
						pluginMessage: {
							type: "get-preset-curves",
						},
					},
					"*"
				);
			});

			// Function to update the preview ramp
			function updatePreviewRamp() {
				if (!currentColor) return;

				// Get the current color as RGB
				let rgbColor;
				try {
					rgbColor = hexToRgb(currentColor);
				} catch (e) {
					console.error("Invalid color for preview:", e);
					return;
				}

				// Create a message to get color ramp from the plugin
				// We'll use the same settings that would be used when clicking "Create Ramp"
				const message = {
					type: "preview-ramp",
					color: currentColor,
					flavor: selectedFlavor,
					isAdvancedMode: isAdvancedMode,
					customContrastTargets: isAdvancedMode ? customContrastTargets : null,
					chromaCurveSettings: isAdvancedMode
						? {
								customStops: chromaCurveSettings.customStops,
								hueCurveSettings: hueCurveSettings,
						  }
						: null,
				};

				// Post message to plugin
				parent.postMessage({ pluginMessage: message }, "*");
			}

			// Add message handler for preview ramp response
			window.addEventListener("message", (event) => {
				const msg = event.data.pluginMessage;
				if (msg && msg.type === "preview-ramp-colors") {
					// Update the preview swatches with the colors
					updatePreviewSwatches(msg.colors, msg.contrastValues);
				}
			});

			// Function to update the preview swatches with colors
			function updatePreviewSwatches(colors, contrastValues) {
				if (!colors) return;

				// Update expanded preview swatches
				expandedSwatches.forEach((swatch) => {
					const step = swatch.getAttribute("data-step");
					if (colors[step]) {
						const color = colors[step];
						const hex = rgbToHex(color.r, color.g, color.b);
						swatch.style.backgroundColor = hex;

						// Update the info display
						const infoElement = swatch.querySelector(".expanded-swatch-info");
						if (infoElement) {
							const contrastValue =
								contrastValues && contrastValues[step]
									? contrastValues[step].toFixed(1)
									: "";

							// Show either Hex or LCH format based on toggle state
							if (showLCH && color.lch) {
								// Format LCH values in CSS oklch() syntax
								const l = Math.round(color.lch.l * 100);
								const c = color.lch.c.toFixed(3);
								const h = Math.round(color.lch.h);
								infoElement.innerHTML = `oklch(${l}% ${c} ${h}) <span style="opacity: 0.7">${
									contrastValue ? "• " + contrastValue : ""
								}</span>`;
							} else {
								// Format Hex value
								infoElement.innerHTML = `${hex.toUpperCase()} <span style="opacity: 0.7">${
									contrastValue ? "• " + contrastValue : ""
								}</span>`;
							}
						}
					}
				});
			}

			// Convert RGB to hex helper function for preview
			function rgbToHex(r, g, b) {
				r = Math.round(r * 255);
				g = Math.round(g * 255);
				b = Math.round(b * 255);
				return (
					"#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)
				);
			}

			// Convert hex to RGB helper function for preview
			function hexToRgb(hex) {
				// Remove # if present
				hex = hex.replace(/^#/, "");

				// Parse the hex values
				const bigint = parseInt(hex, 16);
				const r = ((bigint >> 16) & 255) / 255;
				const g = ((bigint >> 8) & 255) / 255;
				const b = (bigint & 255) / 255;

				return { r, g, b };
			}
		</script>
	</body>
</html>
